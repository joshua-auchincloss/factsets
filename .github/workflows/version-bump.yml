name: Version Bump PR

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Target version (e.g., 0.2.0 or v0.2.0)'
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  version-bump:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main
        uses: actions/checkout@v6
        with:
          ref: main

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Normalize version
        id: version
        run: |
          VERSION="${{ github.event.inputs.version }}"
          # Strip 'v' prefix if present
          VERSION="${VERSION#v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "branch=release/v$VERSION" >> $GITHUB_OUTPUT

      - name: Run version script
        if: ${{ steps.version.outputs.version != '' }}
        run: bun scripts/version.ts ${{ steps.version.outputs.version }}

      - name: Check for changes
        if: ${{ steps.version.outputs.version != '' }}
        id: changes
        run: |
          if git diff --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No version changes detected"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Version changes detected:"
            git diff --stat
          fi

      - name: Create branch and commit
        if: ${{ steps.version.outputs.version != '' && steps.changes.outputs.has_changes == 'true'}}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b ${{ steps.version.outputs.branch }}
          git add package.json server.json
          git commit -m "chore: bump version to ${{ steps.version.outputs.version }}"
          git push origin ${{ steps.version.outputs.branch }}

      - name: Create Pull Request
        if: ${{ steps.version.outputs.version != '' && steps.changes.outputs.has_changes == 'true'}}
        uses: actions/github-script@v7
        with:
          script: |
            const version = '${{ steps.version.outputs.version }}';
            const branch = '${{ steps.version.outputs.branch }}';

            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `chore: release v${version}`,
              head: branch,
              base: 'main',
              body: `## Version Bump to v${version}

            This PR was automatically created by the version bump workflow.

            ### Changes
            - Updated \`package.json\` version to \`${version}\`
            - Updated \`server.json\` version to \`${version}\`

            ### Checklist
            - [ ] Version number is correct
            - [ ] All tests pass
            - [ ] Ready to merge and tag release
            `
            });

            console.log(`Created PR #${pr.number}: ${pr.html_url}`);

            // Add labels if they exist
            try {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                labels: ['release', 'automated']
              });
            } catch (e) {
              console.log('Could not add labels (they may not exist):', e.message);
            }

      - name: Summary
        if: ${{ steps.version.outputs.version != '' && steps.changes.outputs.has_changes == 'true'}}
        run: |
          echo "## Version Bump Complete ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ steps.version.outputs.branch }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "A pull request has been created for review." >> $GITHUB_STEP_SUMMARY

      - name: No changes summary
        if: ${{ steps.version.outputs.version != '' && steps.changes.outputs.has_changes == 'false'}}
        run: |
          echo "## No Changes Needed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The version is already set to ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
